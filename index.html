<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>OpenLibrek ‚Äì di Angelini Matteo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    :root {
        --bg: #f5f5f5;
        --text: #000;
        --muted: #555;
        --table-border: #ccc;
        --link: #0645ad;
        --link-hover: #0b0080;
        --header-bg: #e5e5e5;
        --accent: #1b7fd0;
        --accent-soft: #d9ecff;
        --highlight: #fff3b0;
        --badge-bg: #eee;
    }

    body.dark {
        --bg: #111;
        --text: #f5f5f5;
        --muted: #aaa;
        --table-border: #333;
        --link: #4db2ff;
        --link-hover: #9ad4ff;
        --header-bg: #1b1b1b;
        --accent: #4db2ff;
        --accent-soft: #102233;
        --highlight: #4b3f00;
        --badge-bg: #222;
    }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    a {
        color: var(--link);
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
        color: var(--link-hover);
    }

    header {
        text-align: center;
        padding: 20px 10px 10px;
        border-bottom: 1px solid var(--table-border);
        background: #fff;
    }

    body.dark header {
        background: #000;
    }

    h1 {
        font-size: 40px;
        margin: 0;
        color: var(--accent);
        font-weight: bold;
    }

    .subtitle {
        margin-top: 4px;
        font-size: 13px;
        color: var(--muted);
    }

    .warning {
        margin-top: 8px;
        font-size: 12px;
        color: #c00;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px 8px;
        border-bottom: 1px solid var(--table-border);
        background: var(--header-bg);
        font-size: 13px;
        flex-wrap: wrap;
        gap: 6px;
    }

    .nav-links a {
        margin-right: 10px;
        font-weight: bold;
    }

    .theme-toggle {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--table-border);
        background: #fff;
    }

    body.dark .theme-toggle {
        background: #000;
    }

    .container {
        max-width: 1100px;
        margin: 10px auto 30px;
        padding: 0 8px;
        font-size: 14px;
    }

    .stats-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
    }

    .badge {
        background: var(--badge-bg);
        border-radius: 999px;
        padding: 3px 8px;
        border: 1px solid var(--table-border);
    }

    .search-box {
        margin: 15px 0 10px;
        text-align: center;
    }

    .search-box input[type="text"] {
        width: 70%;
        max-width: 500px;
        padding: 7px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid var(--table-border);
        background: #fff;
        color: var(--text);
    }

    body.dark .search-box input[type="text"] {
        background: #000;
    }

    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 12px;
    }

    .filters select {
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid var(--table-border);
        background: #fff;
        color: var(--text);
    }

    body.dark .filters select {
        background: #000;
    }

    .categories {
        margin: 10px 0;
        text-align: center;
    }

    .cat-pill {
        display: inline-block;
        margin: 2px 4px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid var(--table-border);
        cursor: pointer;
        font-size: 12px;
        background: #fff;
    }

    body.dark .cat-pill {
        background: #000;
    }

    .cat-pill.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 13px;
    }

    th, td {
        padding: 6px 4px;
        border-bottom: 1px solid var(--table-border);
        text-align: left;
    }

    th {
        background: var(--header-bg);
        cursor: pointer;
        white-space: nowrap;
    }

    .sortable::after {
        content: " ‚áÖ";
        font-size: 11px;
        color: var(--muted);
    }

    .icon-col {
        width: 24px;
        text-align: center;
    }

    .type-col {
        width: 70px;
        white-space: nowrap;
    }

    .download-col {
        width: 40px;
        text-align: center;
    }

    .pagination {
        margin-top: 10px;
        text-align: center;
    }

    .pagination button {
        margin: 0 2px;
        padding: 3px 7px;
        font-size: 12px;
        border-radius: 3px;
        border: 1px solid var(--table-border);
        background: #fff;
        cursor: pointer;
    }

    body.dark .pagination button {
        background: #000;
    }

    .pagination button.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
    }

    #detailsPage {
        display: none;
        margin-top: 15px;
        border-top: 1px solid var(--table-border);
        padding-top: 10px;
    }

    .back-btn {
        display: inline-block;
        margin-bottom: 10px;
        padding: 4px 8px;
        background: var(--accent-soft);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        border: 1px solid var(--accent);
        color: var(--accent);
    }

    .field-label {
        font-weight: bold;
    }

    .highlight {
        background: var(--highlight);
        padding: 0 1px;
    }

    .note {
        font-size: 12px;
        color: var(--muted);
    }

    @media (max-width: 700px) {
        .search-box input[type="text"] { width: 95%; }
        th, td { font-size: 12px; }
    }
</style>
</head>

<body>
<header>
    <h1>OpenLibrek</h1>
    <div class="subtitle">La libreria digitale di Angelini Matteo</div>
    <div class="warning">‚ö†Ô∏è Il sito NON √® open source. Sono presenti solo file creati da Angelini Matteo.</div>
</header>

<div class="top-bar">
    <div class="nav-links">
        <a href="#" onclick="showMain();return false;">Lista file</a>
    </div>
    <div>
        <button class="theme-toggle" onclick="toggleTheme()">Tema chiaro/scuro</button>
    </div>
</div>

<div class="container">

    <div class="stats-bar">
        <span class="badge" id="statCount">File: 0</span>
        <span class="badge" id="statCategories">Categorie: 0</span>
        <span class="badge" id="statLast">Ultimo upload: -</span>
    </div>

    <div id="listPage">
        <div class="search-box">
            <input type="text" id="search" placeholder="Cerca un file...">
        </div>

        <div class="filters">
            <span>Tipo file:
                <select id="typeFilter">
                    <option value="all">Tutti</option>
                    <option value="doc">Documenti</option>
                    <option value="pdf">PDF</option>
                    <option value="zip">Archivi</option>
                    <option value="exe">Programmi</option>
                    <option value="script">Script</option>
                    <option value="altro">Altro</option>
                </select>
            </span>
        </div>

        <div class="categories" id="categories"></div>

        <table id="fileTable">
            <thead>
                <tr>
                    <th class="icon-col"></th>
                    <th class="sortable" data-col="categoria">Categoria</th>
                    <th class="sortable" data-col="nome">Nome</th>
                    <th class="type-col sortable" data-col="tipo">Tipo</th>
                    <th class="sortable" data-col="upload">Upload</th>
                    <th class="sortable" data-col="peso">Peso</th>
                    <th class="download-col">DL</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>

    <div id="detailsPage">
        <div class="back-btn" onclick="showMain()">‚¨Ö Torna alla lista</div>
        <h2 id="d_nome"></h2>
        <p><span class="field-label">Categoria:</span> <span id="d_categoria"></span></p>
        <p><span class="field-label">Tipo file:</span> <span id="d_tipo"></span></p>
        <p><span class="field-label">Upload:</span> <span id="d_upload"></span></p>
        <p><span class="field-label">Peso:</span> <span id="d_peso"></span></p>
        <p><span class="field-label">SHA‚Äë1:</span> <span id="d_sha"></span></p>
        <p><span class="field-label">Descrizione:</span> <span id="d_descrizione"></span></p>
        <p><span class="field-label">Download:</span> <a id="d_link" href="#" target="_blank">Clicca qui per scaricare</a></p>
        <p class="note">Link diretto a questa pagina: <span id="d_direct"></span></p>
    </div>

</div>

<script>
let files = [];
let filtered = [];
let currentPage = 1;
const pageSize = 30;
let currentSort = { col: null, dir: 1 };
let currentCategory = null;
let searchTerm = "";

// Tema
function toggleTheme() {
    document.body.classList.toggle('dark');
    localStorage.setItem('openlibrek_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}
(function initTheme() {
    const t = localStorage.getItem('openlibrek_theme');
    if (t === 'dark') document.body.classList.add('dark');
})();

// Navigazione
function showMain() {
    document.getElementById('listPage').style.display = 'block';
    document.getElementById('detailsPage').style.display = 'none';
    history.replaceState(null, "", location.pathname);
}
function openDetails(id) {
    const f = files.find(x => x.id === id);
    if (!f) return;
    document.getElementById("d_nome").textContent = f.nome;
    document.getElementById("d_categoria").textContent = f.categoria || "";
    document.getElementById("d_tipo").textContent = f.tipo || "";
    document.getElementById("d_upload").textContent = f.upload || "";
    document.getElementById("d_peso").textContent = f.peso || "";
    document.getElementById("d_sha").textContent = f.sha1 || "";
    document.getElementById("d_descrizione").textContent = f.descrizione || "";
    document.getElementById("d_link").href = f.link || "#";
    const direct = location.origin + location.pathname + "#file=" + id;
    document.getElementById("d_direct").textContent = direct;
    document.getElementById('listPage').style.display = 'none';
    document.getElementById('detailsPage').style.display = 'block';
    history.replaceState(null, "", location.pathname + "#file=" + id);
}
function handleHashOnLoad() {
    const hash = location.hash;
    if (!hash) return;
    if (hash.startsWith("#file=")) {
        const id = parseInt(hash.split("=")[1], 10);
        if (!isNaN(id)) openDetails(id);
    }
}

// Tipo file
function detectType(f) {
    const link = (f.link || "").toLowerCase();
    const name = (f.nome || "").toLowerCase();
    const src = link || name;
    if (src.endsWith(".pdf")) return "PDF";
    if (src.endsWith(".doc") || src.endsWith(".docx") || src.endsWith(".odt")) return "DOC";
    if (src.endsWith(".txt") || src.endsWith(".md")) return "TXT";
    if (src.endsWith(".zip") || src.endsWith(".rar") || src.endsWith(".7z")) return "ZIP";
    if (src.endsWith(".exe") || src.endsWith(".msi")) return "EXE";
    if (src.endsWith(".bat") || src.endsWith(".ps1") || src.endsWith(".sh") || src.endsWith(".py")) return "SCRIPT";
    return "ALTRO";
}
function getIconByType(tipo) {
    const t = (tipo || "").toUpperCase();
    if (t === "SCRIPT") return "‚öôÔ∏è";
    if (t === "PDF") return "üìï";
    if (t === "DOC") return "üìÑ";
    if (t === "TXT") return "üìÉ";
    if (t === "ZIP") return "üóúÔ∏è";
    if (t === "EXE") return "üíæ";
    return "üìÅ";
}

// Carica database.json
fetch("database.json?cachebust=" + Date.now())
    .then(r => r.json())
    .then(data => {
        files = data.map((f, idx) => {
            f.id = f.id || idx + 1;
            f.tipo = detectType(f);
            return f;
        });
        filtered = [...files];
        buildCategories();
        updateStats();
        render();
        handleHashOnLoad();
    });

// Statistiche
function updateStats() {
    const statCount = document.getElementById("statCount");
    const statCategories = document.getElementById("statCategories");
    const statLast = document.getElementById("statLast");

    statCount.textContent = "File: " + files.length;

    const cats = Array.from(new Set(files.map(f => f.categoria).filter(c => c)));
    statCategories.textContent = "Categorie: " + cats.length;

    const dates = files.map(f => f.upload).filter(Boolean).sort();
    statLast.textContent = "Ultimo upload: " + (dates.length ? dates[dates.length - 1] : "-");
}

// Categorie
function buildCategories() {
    const catDiv = document.getElementById('categories');
    const cats = Array.from(new Set(files.map(f => f.categoria).filter(c => c)));
    catDiv.innerHTML = '';
    if (!cats.length) return;
    const all = document.createElement('span');
    all.textContent = 'Tutte';
    all.className = 'cat-pill active';
    all.dataset.cat = '';
    all.onclick = () => setCategory(null);
    catDiv.appendChild(all);
    cats.forEach(c => {
        const span = document.createElement('span');
        span.textContent = c;
        span.className = 'cat-pill';
        span.dataset.cat = c;
        span.onclick = () => setCategory(c);
        catDiv.appendChild(span);
    });
}
function setCategory(cat) {
    currentCategory = cat;
    document.querySelectorAll('.cat-pill').forEach(p => {
        p.classList.toggle('active', (p.dataset.cat || '') === (cat || ''));
    });
    applyFilters();
}

// Filtri + ricerca
document.getElementById("search").addEventListener("input", applyFilters);
document.getElementById("typeFilter").addEventListener("change", applyFilters);

function applyFilters() {
    const q = document.getElementById('search').value.toLowerCase().trim();
    searchTerm = q;
    const typeFilter = document.getElementById('typeFilter').value;

    filtered = files.filter(f => {
        let okCat = true;
        if (currentCategory) okCat = f.categoria === currentCategory;

        let okSearch = true;
        if (q) {
            const target = (f.nome + " " + f.categoria + " " + f.tipo + " " + (f.descrizione || "")).toLowerCase();
            if (q.length === 1) okSearch = target.startsWith(q);
            else okSearch = target.includes(q);
        }

        let okType = true;
        if (typeFilter !== "all") {
            const t = (f.tipo || "").toUpperCase();
            if (typeFilter === "doc") okType = (t === "DOC" || t === "TXT");
            if (typeFilter === "pdf") okType = (t === "PDF");
            if (typeFilter === "zip") okType = (t === "ZIP");
            if (typeFilter === "exe") okType = (t === "EXE");
            if (typeFilter === "script") okType = (t === "SCRIPT");
            if (typeFilter === "altro") okType = (t === "ALTRO");
        }

        return okCat && okSearch && okType;
    });

    currentPage = 1;
    render();
}

// Ordinamento
document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (currentSort.col === col) currentSort.dir *= -1;
        else { currentSort.col = col; currentSort.dir = 1; }
        render();
    });
});
function sortData() {
    if (!currentSort.col) return;
    const col = currentSort.col;
    const dir = currentSort.dir;
    filtered.sort((a, b) => {
        let va = a[col] || "";
        let vb = b[col] || "";
        va = va.toString().toLowerCase();
        vb = vb.toString().toLowerCase();
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
    });
}

// Highlight
function highlight(text) {
    if (!searchTerm) return text;
    const q = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp(q, "ig");
    return text.replace(re, m => `<span class="highlight">${m}</span>`);
}

// Render
function render() {
    sortData();
    renderTable();
    renderPagination();
}
function renderTable() {
    const tbody = document.querySelector("#fileTable tbody");
    tbody.innerHTML = "";
    const start = (currentPage - 1) * pageSize;
    const pageItems = filtered.slice(start, start + pageSize);
    pageItems.forEach(f => {
        const tr = document.createElement("tr");
        const icon = getIconByType(f.tipo);
        tr.innerHTML = `
            <td class="icon-col">${icon}</td>
            <td>${f.categoria || ""}</td>
            <td><a href="#" onclick="openDetails(${f.id});return false;">${highlight(f.nome || "")}</a></td>
            <td class="type-col">${f.tipo || ""}</td>
            <td>${f.upload || ""}</td>
            <td>${f.peso || ""}</td>
            <td class="download-col"><a href="${f.link || '#'}" target="_blank">‚¨á</a></td>
        `;
        tbody.appendChild(tr);
    });
}
function renderPagination() {
    const pagDiv = document.getElementById('pagination');
    pagDiv.innerHTML = '';
    const totalPages = Math.ceil(filtered.length / pageSize) || 1;
    if (totalPages <= 1) return;
    const prev = document.createElement('button');
    prev.textContent = '¬´';
    prev.disabled = currentPage === 1;
    prev.onclick = () => { if (currentPage > 1) { currentPage--; render(); } };
    pagDiv.appendChild(prev);
    for (let p = 1; p <= totalPages; p++) {
        const btn = document.createElement('button');
        btn.textContent = p;
        if (p === currentPage) btn.classList.add('active');
        btn.onclick = () => { currentPage = p; render(); };
        pagDiv.appendChild(btn);
    }
    const next = document.createElement('button');
    next.textContent = '¬ª';
    next.disabled = currentPage === totalPages;
    next.onclick = () => { if (currentPage < totalPages) { currentPage++; render(); } };
    pagDiv.appendChild(next);
}

// Avvio
showMain();
</script>

</body>
</html>
